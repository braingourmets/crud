---
name: CI
on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: '15 3 * * 1'
jobs:
  static-analysis:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: "Set up Ruby 2.7"
        uses: actions/setup-ruby@v1
        with:
          ruby-version: 2.7.2
      - name: "Check the environment"
        run: |
          ruby --version
          gem --version
          bundle --version
      - uses: actions/cache@v2
        with:
          path: "vendor/bundle"
          key: "${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}"
          restore-keys: "${{ runner.os }}-gems-"
      - name: "Install dependencies"
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3
          bundle exec rails version
      - name: "Run the static analysis"
        run: "RAILS_ENV=test bundle exec rails ci"
  brakeman:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: "Set up Ruby 2.7"
        uses: actions/setup-ruby@v1
        with:
          ruby-version: 2.7.2
      - name: "Install dependencies"
        run: "gem install brakeman"
      - name: "Run the security checker"
        run: "brakeman -z -6"
